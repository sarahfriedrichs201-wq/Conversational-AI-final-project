# Graviton Support for PyTorch and TensorFlow Frameworks - Implementation Guide

## Overview

This document provides detailed implementation instructions for adding Graviton instance support to the SageMaker Python SDK for PyTorch and TensorFlow frameworks. Graviton instances are AWS's ARM-based processors that offer cost savings and performance benefits.

## Repository Context

The SageMaker Python SDK uses the `image_uris.py` module to generate appropriate Docker image URIs for different frameworks, instance types, and regions. The implementation will extend the existing image URI retrieval system to support Graviton instances.

## Implementation Plan

### 1. Understanding the Current Architecture

The image URI system works by:
- Mapping frameworks to their respective image configs
- Determining the appropriate processor type (CPU/GPU) from instance type
- Building the complete image URI based on framework, version, region, and instance type

### 2. Required Changes

#### File: `src/sagemaker/image_uris.py`

**Step 1: Add Graviton Instance Type Detection**

```python
def _is_graviton_instance(instance_type):
    """
    Check if the instance type is a Graviton (ARM-based) instance.
    
    Args:
        instance_type (str): The instance type (e.g., 'ml.c6g.4xlarge', 'ml.t4g.2xlarge')
    
    Returns:
        bool: True if the instance type is Graviton-based
    """
    graviton_families = ['c6g', 'c6gd', 'c6gn', 'm6g', 'm6gd', 'r6g', 'r6gd', 't4g']
    instance_family = instance_type.split('.')[1]  # Extract 'c6g' from 'ml.c6g.4xlarge'
    return instance_family in graviton_families
```

**Step 2: Update Image Scope Detection**

```python
def _get_image_scope_for_instance_type(framework, instance_type, image_scope):
    """
    Extract the image scope from instance type, considering Graviton instances.
    
    Args:
        framework (str): The framework name (e.g., 'pytorch', 'tensorflow')
        instance_type (str): The instance type
        image_scope (str): The image scope (e.g., 'training', 'inference')
    
    Returns:
        str: The appropriate image scope identifier
    """
    # Check if this is a Graviton instance
    if _is_graviton_instance(instance_type):
        return f"{image_scope}-graviton"
    
    # Fall back to existing logic for non-Graviton instances
    if instance_type.startswith('ml.inf'):
        return f"{image_scope}-neuron"
    elif instance_type.startswith('ml.trn'):
        return f"{image_scope}-neuronx"
    else:
        return image_scope
```

**Step 3: Update Framework-Specific Configurations**

Add Graviton-specific image configurations for PyTorch and TensorFlow:

```python
# In the framework-specific configuration sections

# PyTorch Graviton configuration
PYTORCH_GRAVITON_INFERENCE_CPU_INSTANCE_TYPES = {
    "versions": {
        "1.12.1": {
            "registries": {
                # Add all regions where Graviton images are available
                "us-west-2": "763104351884",
                "us-east-1": "763104351884",
                "eu-west-1": "763104351884",
                # Add other regions as they become available
            },
            "py_versions": ["py38"],
            "repository": "pytorch-inference-graviton",
            "tag_prefix": "1.12.1-cpu-py38-ubuntu20.04-sagemaker"
        }
    }
}

# TensorFlow Graviton configuration  
TENSORFLOW_GRAVITON_INFERENCE_CPU_INSTANCE_TYPES = {
    "versions": {
        "2.9.1": {
            "registries": {
                "us-west-2": "763104351884",
                "us-east-1": "763104351884",
                "eu-west-1": "763104351884",
                # Add other regions as they become available
            },
            "py_versions": ["py38"],
            "repository": "tensorflow-inference-graviton",
            "tag_prefix": "2.9.1-cpu-py38-ubuntu20.04-sagemaker"
        }
    }
}
```

**Step 4: Update the Main Image URI Retrieval Function**

Modify the `retrieve` function to handle Graviton instances:

```python
def retrieve(framework, region, version=None, py_version=None, instance_type=None, 
             image_scope=None, accelerator_type=None, container_version=None, 
             distribution=None, base_framework_version=None, training_compiler_config=None):
    """
    Retrieve the appropriate image URI for the given parameters.
    
    This function should be updated to:
    1. Detect Graviton instances
    2. Use Graviton-specific image configs when appropriate
    3. Fall back to existing logic for non-Graviton instances
    """
    # Existing logic for parameter validation...
    
    # Determine if this is a Graviton instance
    if instance_type and _is_graviton_instance(instance_type):
        # Use Graviton-specific image scope
        image_scope = _get_image_scope_for_instance_type(framework, instance_type, image_scope)
        
        # Get Graviton-specific config
        config = _get_framework_config(framework, image_scope)
        
        # If no Graviton config found, fall back to regular config
        if not config:
            config = _get_framework_config(framework, image_scope.replace("-graviton", ""))
    else:
        # Use existing logic for non-Graviton instances
        config = _get_framework_config(framework, image_scope)
    
    # Rest of existing image URI building logic...
```

### 3. Framework-Specific Implementation Details

#### PyTorch Graviton Support

**Supported Versions**: 1.12.1 (initial support)
**Python Versions**: py38
**Instance Types**: ml.c6g.*, ml.m6g.*, ml.r6g.*, ml.t4g.*

**Image URI Pattern**:
```
763104351884.dkr.ecr.{region}.amazonaws.com/pytorch-inference-graviton:1.12.1-cpu-py38-ubuntu20.04-sagemaker
```

#### TensorFlow Graviton Support

**Supported Versions**: 2.9.1 (initial support)  
**Python Versions**: py38
**Instance Types**: ml.c6g.*, ml.m6g.*, ml.r6g.*, ml.t4g.*

**Image URI Pattern**:
```
763104351884.dkr.ecr.{region}.amazonaws.com/tensorflow-inference-graviton:2.9.1-cpu-py38-ubuntu20.04-sagemaker
```

### 4. Testing Implementation

**Unit Tests**:

Create test file: `tests/unit/test_image_uris_graviton.py`

```python
import pytest
from sagemaker.image_uris import retrieve, _is_graviton_instance

class TestGravitonImageURIs:
    
    def test_graviton_instance_detection(self):
        """Test that Graviton instances are correctly identified."""
        assert _is_graviton_instance("ml.c6g.4xlarge") == True
        assert _is_graviton_instance("ml.t4g.2xlarge") == True
        assert _is_graviton_instance("ml.m6g.12xlarge") == True
        assert _is_graviton_instance("ml.c5.4xlarge") == False
        assert _is_graviton_instance("ml.p3.2xlarge") == False
    
    def test_pytorch_graviton_image_uri(self):
        """Test PyTorch Graviton image URI generation."""
        image_uri = retrieve(
            framework="pytorch",
            region="us-west-2", 
            version="1.12.1",
            instance_type="ml.c6g.4xlarge"
        )
        
        expected_uri = "763104351884.dkr.ecr.us-west-2.amazonaws.com/pytorch-inference-graviton:1.12.1-cpu-py38-ubuntu20.04-sagemaker"
        assert image_uri == expected_uri
    
    def test_tensorflow_graviton_image_uri(self):
        """Test TensorFlow Graviton image URI generation."""
        image_uri = retrieve(
            framework="tensorflow",
            region="us-west-2",
            version="2.9.1", 
            instance_type="ml.t4g.2xlarge"
        )
        
        expected_uri = "763104351884.dkr.ecr.us-west-2.amazonaws.com/tensorflow-inference-graviton:2.9.1-cpu-py38-ubuntu20.04-sagemaker"
        assert image_uri == expected_uri
    
    def test_non_graviton_fallback(self):
        """Test that non-Graviton instances use regular images."""
        graviton_uri = retrieve("pytorch", "us-west-2", instance_type="ml.c6g.4xlarge")
        non_graviton_uri = retrieve("pytorch", "us-west-2", instance_type="ml.c5.4xlarge")
        
        assert graviton_uri != non_graviton_uri
        assert "graviton" in graviton_uri
        assert "graviton" not in non_graviton_uri
```

**Integration Tests**:

Update existing integration tests to include Graviton instances where appropriate.

### 5. Documentation Updates

**Update API Documentation**:

Add Graviton support information to the relevant framework documentation:

```rst
Graviton Instance Support
-------------------------

SageMaker now supports AWS Graviton instances for PyTorch and TensorFlow frameworks.
Graviton instances provide cost savings and are ideal for CPU-based workloads.

Supported Instance Types:
- ml.c6g.*
- ml.m6g.*  
- ml.r6g.*
- ml.t4g.*

Example Usage:

.. code-block:: python

    # PyTorch with Graviton
    estimator = PyTorch(
        entry_point='script.py',
        instance_type='ml.c6g.4xlarge',
        instance_count=1,
        framework_version='1.12.1',
        py_version='py38'
    )

    # TensorFlow with Graviton  
    estimator = TensorFlow(
        entry_point='script.py', 
        instance_type='ml.t4g.2xlarge',
        instance_count=1,
        framework_version='2.9.1',
        py_version='py38'
    )
```

### 6. Code Style Guidelines

- Follow existing Python SDK code style (Black formatter)
- Use type hints where appropriate
- Maintain backward compatibility - existing code should continue to work unchanged
- Add comprehensive docstrings for new functions
- Follow existing error handling patterns

### 7. Validation Checklist

Before submitting the PR:

- [ ] All unit tests pass
- [ ] Integration tests validate Graviton image URI generation
- [ ] Code follows existing style guidelines
- [ ] Documentation is updated
- [ ] Backward compatibility is maintained
- [ ] CHANGELOG.md is updated with the new feature
- [ ] All regions with Graviton support are included
- [ ] Error handling for unsupported regions/versions

### 8. Expected Output Examples

After implementation, the following should work:

```python
# PyTorch Graviton
>>> sagemaker.image_uris.retrieve("pytorch", "us-west-2", instance_type="ml.c6g.4xlarge")
'763104351884.dkr.ecr.us-west-2.amazonaws.com/pytorch-inference-graviton:1.12.1-cpu-py38-ubuntu20.04-sagemaker'

# TensorFlow Graviton  
>>> sagemaker.image_uris.retrieve("tensorflow", "us-west-2", instance_type="ml.t4g.2xlarge")
'763104351884.dkr.ecr.us-west-2.amazonaws.com/tensorflow-inference-graviton:2.9.1-cpu-py38-ubuntu20.04-sagemaker'
```

This implementation provides a clean, extensible foundation for Graviton support that can be easily expanded to include additional frameworks and versions as they become available.